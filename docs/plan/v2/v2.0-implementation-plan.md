# DocVault v2.0 Implementation Plan

**Version:** 2.0.0  
**Status:** Planning  
**Created:** November 20, 2025  
**Target Release:** Q1 2026

---

## Executive Summary

DocVault v2.0 represents a major architectural evolution focused on simplifying the data model and enhancing API capabilities. The core philosophy shifts from storing entity information to managing pure UUID-based references, making DocVault a lightweight, flexible document management layer.

### Key Changes
- **Simplified Entity Model**: Organizations and Agents become pure UUID references without name/metadata
- **Enhanced Document Discovery**: Hierarchical prefix-based organization with recursive search
- **Flexible Upload API**: Support for multiple input types (file paths, bytes, binary streams)
- **Streamlined Permissions**: Consolidated get/set permissions API
- **Breaking Changes**: Complete API redesign requiring migration from v1.x

---

## Table of Contents

1. [Breaking Changes Overview](#breaking-changes-overview)
2. [Architecture Changes](#architecture-changes)
3. [Implementation Phases](#implementation-phases)
4. [Detailed Phase Breakdown](#detailed-phase-breakdown)
5. [Testing Strategy](#testing-strategy)
6. [Migration Guide](#migration-guide)
7. [Risk Assessment](#risk-assessment)
8. [Timeline](#timeline)

---

## Breaking Changes Overview

### Database Schema Changes

#### Organizations Table
```sql
-- BEFORE (v1.x)
CREATE TABLE organizations (
    id UUID PRIMARY KEY,
    external_id VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    metadata JSONB,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- AFTER (v2.0)
CREATE TABLE organizations (
    id UUID PRIMARY KEY,  -- Now accepts external UUIDs
    metadata JSONB,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### Agents Table
```sql
-- BEFORE (v1.x)
CREATE TABLE agents (
    id UUID PRIMARY KEY,
    external_id VARCHAR(255) UNIQUE NOT NULL,
    organization_id UUID NOT NULL,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    agent_type VARCHAR(50),
    metadata JSONB,
    is_active BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- AFTER (v2.0)
CREATE TABLE agents (
    id UUID PRIMARY KEY,  -- Now accepts external UUIDs
    organization_id UUID NOT NULL,
    metadata JSONB,
    is_active BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### Documents Table (New Fields)
```sql
-- Add hierarchical organization support
ALTER TABLE documents ADD COLUMN prefix VARCHAR(500);
ALTER TABLE documents ADD COLUMN path VARCHAR(1000);
CREATE INDEX idx_documents_prefix ON documents(prefix);
CREATE INDEX idx_documents_path ON documents USING gin(path gin_trgm_ops);
```

### API Changes

#### Removed Methods
```python
# v1.x methods being removed
await vault.share(...)                          # → Use set_permissions()
await vault.revoke(...)                         # → Use set_permissions()
await vault.check_permission(...)               # → Use get_permissions()
await vault.list_accessible_documents(...)      # → Use list_docs()
await vault.get_document_permissions(...)       # → Use get_permissions()
await vault.get_version_info(...)               # → Use get_document_details()
await vault.get_versions(...)                   # → Use get_document_details()
```

#### New/Modified Methods
```python
# New organization management
await vault.delete_organization(org_id: UUID)
await vault.remove_agent(agent_id: UUID)

# Enhanced document listing
await vault.list_docs(
    prefix: Optional[str] = None,
    org_id: UUID,
    agent_id: UUID,
    permission_check: bool = True,
    recursive: bool = False,
    limit: int = 50,
    offset: int = 0,
    max_depth: Optional[int] = None
)

# Detailed document retrieval
await vault.get_document_details(
    document_id: UUID,
    org_id: UUID,
    agent_id: UUID,
    include_versions: bool = False,
    include_permissions: bool = False
)

# Flexible upload
await vault.upload(
    file_path: Union[str, bytes, BinaryIO],
    file_type: str,
    name: str,
    organization_id: UUID,
    agent_id: UUID,
    prefix: Optional[str] = None,
    replace_current_version: bool = False,
    description: Optional[str] = None,
    tags: Optional[List[str]] = None,
    metadata: Optional[Dict[str, Any]] = None
)

# Unified permissions API
await vault.get_permissions(
    document_id: UUID,
    agent_id: UUID,
    org_id: UUID
) -> List[Permission]

await vault.set_permissions(
    document_id: UUID,
    agent_id: UUID,
    org_id: UUID,
    permissions: List[Permission],
    granted_by: UUID
)
```

---

## Architecture Changes

### 1. Entity Reference Model

**Philosophy**: Organizations and Agents are now pure UUID references managed externally. DocVault only tracks:
- UUID identity
- Organization membership
- Activity status
- Custom metadata (optional)

**Benefits**:
- Reduced coupling with external systems
- Simplified schema
- Easier integration with existing identity providers
- No data duplication

### 2. Hierarchical Document Organization

Documents can now be organized hierarchically using prefixes (similar to S3 prefixes):

```
/reports/
/reports/2025/
/reports/2025/q1/
/reports/2025/q1/financial.pdf
/reports/2025/q1/sales.pdf
/projects/
/projects/alpha/
/projects/alpha/design.doc
```

**Features**:
- Prefix-based listing
- Recursive search with depth control
- Efficient query indexing
- Backwards compatible (prefix is optional)

### 3. Flexible Upload System

Support multiple input types:
- **File path** (str): Traditional file upload
- **Bytes** (bytes): In-memory data
- **Binary stream** (BinaryIO): Streaming uploads for large files

### 4. Consolidated Permissions API

Replace multiple permission methods with two comprehensive ones:
- `get_permissions()`: Retrieve all permissions for a document
- `set_permissions()`: Set/update permissions in a single call

---

## Implementation Phases

### Phase 1: Database Schema & Migration
**Duration**: 1 week  
**Priority**: Critical  
**Dependencies**: None

### Phase 2: Repository Layer Updates
**Duration**: 1 week  
**Priority**: Critical  
**Dependencies**: Phase 1

### Phase 3: Schema Models & Validation
**Duration**: 3 days  
**Priority**: High  
**Dependencies**: Phase 1

### Phase 4: Organization & Agent Management
**Duration**: 4 days  
**Priority**: High  
**Dependencies**: Phase 2, 3

### Phase 5: Document Prefix & Hierarchical Support
**Duration**: 1 week  
**Priority**: High  
**Dependencies**: Phase 2, 3

### Phase 6: Enhanced Upload System
**Duration**: 1 week  
**Priority**: High  
**Dependencies**: Phase 2, 3, 5

### Phase 7: Document Listing & Retrieval
**Duration**: 1 week  
**Priority**: High  
**Dependencies**: Phase 5, 6

### Phase 8: Permissions Refactoring
**Duration**: 1 week  
**Priority**: Medium  
**Dependencies**: Phase 2, 3, 4

### Phase 9: Core SDK Integration
**Duration**: 1 week  
**Priority**: High  
**Dependencies**: All previous phases

### Phase 10: Testing & Quality Assurance
**Duration**: 1 week  
**Priority**: Critical  
**Dependencies**: Phase 9

### Phase 11: Documentation & Examples
**Duration**: 4 days  
**Priority**: High  
**Dependencies**: Phase 9

### Phase 12: Release Preparation
**Duration**: 3 days  
**Priority**: Critical  
**Dependencies**: All phases

**Total Estimated Duration**: 10-12 weeks

---

## Detailed Phase Breakdown

### Phase 1: Database Schema & Migration

#### Objectives
- Create v2 schema definition
- Create migration script from v1 to v2
- Update init_db.py for new schema
- Test schema changes

#### Tasks

##### 1.1: Create v2 Schema File
- [ ] Create `src/doc_vault/database/sql/schema_v2.sql`
- [ ] Remove `external_id` from organizations table
- [ ] Remove `name` from organizations table
- [ ] Remove `external_id`, `name`, `email`, `agent_type` from agents table
- [ ] Add `prefix` column to documents table
- [ ] Add `path` column to documents table
- [ ] Update indexes (remove external_id indexes)
- [ ] Add prefix/path indexes
- [ ] Update foreign key constraints
- [ ] Update triggers if needed

##### 1.2: Create Migration Script
- [ ] Create `src/doc_vault/database/sql/migrate_v1_to_v2.sql`
- [ ] Data preservation logic for external_id → id mapping
- [ ] Backup recommendations
- [ ] Rollback instructions
- [ ] Data validation queries

##### 1.3: Update Database Initialization
- [ ] Update `src/doc_vault/database/init_db.py`
- [ ] Add version detection logic
- [ ] Add migration execution
- [ ] Add validation checks
- [ ] Update error handling

##### 1.4: Testing
- [ ] Test fresh v2 database creation
- [ ] Test migration from v1 to v2
- [ ] Test rollback procedures
- [ ] Validate data integrity
- [ ] Performance testing on indexes

#### Deliverables
- `schema_v2.sql`
- `migrate_v1_to_v2.sql`
- Updated `init_db.py`
- Migration test suite
- Documentation for migration process

#### Success Criteria
- ✅ New schema creates successfully
- ✅ Migration from v1 completes without data loss
- ✅ All foreign keys remain valid
- ✅ Indexes perform efficiently
- ✅ Rollback works correctly

---

### Phase 2: Repository Layer Updates

#### Objectives
- Update all repository classes for UUID-based operations
- Remove external_id query methods
- Add delete operations
- Add prefix-based queries
- Update base repository

#### Tasks

##### 2.1: Update Base Repository
- [ ] Update `src/doc_vault/database/repositories/base.py`
- [ ] Change primary ID handling to UUID only
- [ ] Remove external_id lookup methods
- [ ] Update error messages
- [ ] Add delete operation support

##### 2.2: Update Organization Repository
- [ ] Update `src/doc_vault/database/repositories/organization.py`
- [ ] Change `create()` to accept UUID as id
- [ ] Change `get_by_external_id()` → `get_by_id()`
- [ ] Remove `external_id` from queries
- [ ] Remove `name` from queries
- [ ] Add `delete()` method
- [ ] Update `update()` method
- [ ] Update all SQL queries

##### 2.3: Update Agent Repository
- [ ] Update `src/doc_vault/database/repositories/agent.py`
- [ ] Change `create()` to accept UUID as id
- [ ] Change `get_by_external_id()` → `get_by_id()`
- [ ] Remove `external_id`, `name`, `email`, `agent_type` from queries
- [ ] Add `delete()` method
- [ ] Add `remove_from_organization()` method
- [ ] Update `update()` method
- [ ] Update `get_by_organization()` method
- [ ] Update all SQL queries

##### 2.4: Update Document Repository
- [ ] Update `src/doc_vault/database/repositories/document.py`
- [ ] Add `prefix` parameter to create/update
- [ ] Add `path` parameter to create/update
- [ ] Add `list_by_prefix()` method
- [ ] Add `list_recursive()` method with depth control
- [ ] Update `search()` to include prefix filtering
- [ ] Update all agent/org ID queries to use UUID
- [ ] Optimize prefix queries with proper indexes

##### 2.5: Update Version Repository
- [ ] Update `src/doc_vault/database/repositories/version.py`
- [ ] Update agent ID queries to use UUID
- [ ] Add version cleanup for replaced versions
- [ ] Update all SQL queries

##### 2.6: Update ACL Repository
- [ ] Update `src/doc_vault/database/repositories/acl.py`
- [ ] Update agent/org ID queries to use UUID
- [ ] Add bulk permission operations
- [ ] Add `get_all_permissions()` method
- [ ] Add `set_permissions()` method
- [ ] Update all SQL queries

#### Deliverables
- Updated repository classes
- New delete operations
- Prefix-based query methods
- Repository unit tests

#### Success Criteria
- ✅ All repositories use UUID for entity references
- ✅ Delete operations work correctly with cascading
- ✅ Prefix queries return correct results
- ✅ No external_id references remain
- ✅ All tests pass

---

### Phase 3: Schema Models & Validation

#### Objectives
- Update Pydantic schemas
- Remove deprecated fields
- Add new fields
- Update validation rules

#### Tasks

##### 3.1: Update Organization Schema
- [ ] Update `src/doc_vault/database/schemas/organization.py`
- [ ] Remove `external_id` field
- [ ] Remove `name` field
- [ ] Change `id` to accept external UUID
- [ ] Update validation rules
- [ ] Update docstrings

##### 3.2: Update Agent Schema
- [ ] Update `src/doc_vault/database/schemas/agent.py`
- [ ] Remove `external_id` field
- [ ] Remove `name`, `email`, `agent_type` fields
- [ ] Change `id` to accept external UUID
- [ ] Update validation rules
- [ ] Update docstrings

##### 3.3: Update Document Schema
- [ ] Update `src/doc_vault/database/schemas/document.py`
- [ ] Add `prefix` field (Optional[str])
- [ ] Add `path` field (Optional[str])
- [ ] Add path validation rules
- [ ] Update agent/org ID fields to UUID
- [ ] Update docstrings

##### 3.4: Create New Permission Schema
- [ ] Create enhanced Permission model
- [ ] Add permission type enum
- [ ] Add expiration support
- [ ] Add metadata support

##### 3.5: Update Version Schema
- [ ] Update `src/doc_vault/database/schemas/version.py`
- [ ] Update agent ID fields to UUID
- [ ] Update docstrings

##### 3.6: Update ACL Schema
- [ ] Update `src/doc_vault/database/schemas/acl.py`
- [ ] Update agent ID fields to UUID
- [ ] Add bulk operation support
- [ ] Update docstrings

#### Deliverables
- Updated schema files
- Schema validation tests
- Updated type hints

#### Success Criteria
- ✅ All schemas match v2 database structure
- ✅ Validation catches invalid data
- ✅ Type hints are correct
- ✅ Backwards incompatibility is clear

---

### Phase 4: Organization & Agent Management

#### Objectives
- Implement new organization/agent operations
- Add delete functionality
- Update existing CRUD operations
- Handle cascading deletes

#### Tasks

##### 4.1: Update Organization Service Methods
- [ ] Update creation to accept external UUID
- [ ] Add `delete_organization()` method
- [ ] Handle cascade delete checks (documents, agents)
- [ ] Add soft delete option
- [ ] Update error handling

##### 4.2: Update Agent Service Methods
- [ ] Update creation to accept external UUID
- [ ] Add `remove_agent()` method
- [ ] Add `delete_agent()` method (alias)
- [ ] Handle cascade delete checks (documents, ACLs)
- [ ] Update error handling

##### 4.3: Update Core SDK Methods
- [ ] Add `delete_organization()` to SDK
- [ ] Add `remove_agent()` to SDK
- [ ] Update `register_organization()` signature
- [ ] Update `register_agent()` signature
- [ ] Update error messages

##### 4.4: Testing
- [ ] Test organization deletion
- [ ] Test agent removal
- [ ] Test cascade behavior
- [ ] Test soft delete scenarios
- [ ] Test error conditions

#### Deliverables
- Delete operation implementations
- Updated SDK methods
- Integration tests
- Error handling documentation

#### Success Criteria
- ✅ Organizations can be deleted safely
- ✅ Agents can be removed from organizations
- ✅ Cascade deletes work correctly
- ✅ Soft delete option works
- ✅ Error handling is comprehensive

---

### Phase 5: Document Prefix & Hierarchical Support

#### Objectives
- Add prefix/path support to documents
- Implement hierarchical organization
- Add path validation
- Update document creation

#### Tasks

##### 5.1: Add Path Utilities
- [ ] Create `src/doc_vault/utils/path.py`
- [ ] Add path normalization functions
- [ ] Add path validation
- [ ] Add depth calculation
- [ ] Add path parsing utilities

##### 5.2: Update Document Repository
- [ ] Add prefix parameter to `create()`
- [ ] Auto-generate path from prefix + name
- [ ] Add path validation
- [ ] Update storage path generation
- [ ] Add prefix filtering to queries

##### 5.3: Update Document Service
- [ ] Add prefix parameter to document creation
- [ ] Validate prefix format
- [ ] Update storage organization
- [ ] Handle prefix changes on update

##### 5.4: Testing
- [ ] Test prefix validation
- [ ] Test path generation
- [ ] Test hierarchical organization
- [ ] Test special characters in prefixes
- [ ] Test very long prefixes

#### Deliverables
- Path utility module
- Updated document repository
- Prefix validation
- Path generation tests

#### Success Criteria
- ✅ Prefixes work correctly
- ✅ Paths are generated consistently
- ✅ Validation catches invalid prefixes
- ✅ Storage paths are correct
- ✅ Backwards compatible (prefix optional)

---

### Phase 6: Enhanced Upload System

#### Objectives
- Support multiple input types (str, bytes, BinaryIO)
- Add replace_current_version option
- Add file_type parameter
- Improve error handling

#### Tasks

##### 6.1: Update Storage Backend
- [ ] Update `src/doc_vault/storage/s3_client.py`
- [ ] Add `upload_bytes()` method
- [ ] Add `upload_stream()` method
- [ ] Handle different input types
- [ ] Update error handling

##### 6.2: Create Upload Handler
- [ ] Create `src/doc_vault/services/upload_handler.py`
- [ ] Detect input type (str, bytes, BinaryIO)
- [ ] Route to appropriate upload method
- [ ] Calculate file size for all types
- [ ] Generate checksums
- [ ] Handle streaming for large files

##### 6.3: Update Document Service
- [ ] Update `upload()` method signature
- [ ] Add `replace_current_version` logic
- [ ] Integrate upload handler
- [ ] Handle version replacement
- [ ] Update metadata tracking

##### 6.4: Update Core SDK Upload
- [ ] Update `upload()` signature
- [ ] Add type hints for Union types
- [ ] Update docstrings
- [ ] Add usage examples
- [ ] Update error messages

##### 6.5: Testing
- [ ] Test file path upload
- [ ] Test bytes upload
- [ ] Test BinaryIO upload
- [ ] Test large file streaming
- [ ] Test replace_current_version
- [ ] Test error conditions

#### Deliverables
- Upload handler module
- Updated storage backend
- Updated SDK upload method
- Upload type tests

#### Success Criteria
- ✅ All three input types work
- ✅ Replace version works correctly
- ✅ Large files stream efficiently
- ✅ Checksums are calculated correctly
- ✅ Error handling is robust

---

### Phase 7: Document Listing & Retrieval

#### Objectives
- Implement new `list_docs()` method
- Implement `get_document_details()` method
- Add recursive listing
- Add permission filtering

#### Tasks

##### 7.1: Implement list_docs()
- [ ] Create list method in document repository
- [ ] Add prefix filtering
- [ ] Add recursive search with max_depth
- [ ] Add permission checking option
- [ ] Add pagination (limit/offset)
- [ ] Optimize query performance

##### 7.2: Implement Recursive Search
- [ ] Create recursive query builder
- [ ] Implement depth tracking
- [ ] Handle max_depth parameter
- [ ] Optimize for large result sets
- [ ] Add caching for performance

##### 7.3: Implement get_document_details()
- [ ] Create detail retrieval method
- [ ] Add include_versions option
- [ ] Add include_permissions option (owner only)
- [ ] Combine data from multiple sources
- [ ] Optimize queries

##### 7.4: Update Document Service
- [ ] Add `list_docs()` service method
- [ ] Add `get_document_details()` service method
- [ ] Add permission checking logic
- [ ] Handle pagination
- [ ] Add result formatting

##### 7.5: Update Core SDK
- [ ] Add `list_docs()` to SDK
- [ ] Add `get_document_details()` to SDK
- [ ] Update docstrings
- [ ] Add usage examples

##### 7.6: Testing
- [ ] Test flat listing
- [ ] Test recursive listing
- [ ] Test depth limits
- [ ] Test permission filtering
- [ ] Test pagination
- [ ] Test detail retrieval
- [ ] Test include options
- [ ] Performance testing

#### Deliverables
- list_docs() implementation
- get_document_details() implementation
- Recursive search logic
- Listing tests

#### Success Criteria
- ✅ Flat listing works correctly
- ✅ Recursive listing respects max_depth
- ✅ Permission filtering is accurate
- ✅ Pagination works correctly
- ✅ Detail retrieval is efficient
- ✅ Performance is acceptable

---

### Phase 8: Permissions Refactoring

#### Objectives
- Implement `get_permissions()` method
- Implement `set_permissions()` method
- Remove old permission methods
- Update permission checking

#### Tasks

##### 8.1: Implement get_permissions()
- [ ] Create method in ACL repository
- [ ] Query all permissions for document
- [ ] Add agent filtering
- [ ] Add permission type filtering
- [ ] Handle expiration checking
- [ ] Format results

##### 8.2: Implement set_permissions()
- [ ] Create method in ACL repository
- [ ] Support bulk permission updates
- [ ] Add permission granting logic
- [ ] Add permission revocation logic
- [ ] Handle expiration dates
- [ ] Validate permission types

##### 8.3: Update Access Service
- [ ] Add `get_permissions()` service method
- [ ] Add `set_permissions()` service method
- [ ] Update internal permission checking
- [ ] Remove old service methods (share, revoke, check)
- [ ] Update error handling

##### 8.4: Update Core SDK
- [ ] Add `get_permissions()` to SDK
- [ ] Add `set_permissions()` to SDK
- [ ] Remove old methods (share, revoke, check_permission)
- [ ] Remove list_accessible_documents
- [ ] Remove get_document_permissions
- [ ] Update docstrings

##### 8.5: Update Permission Models
- [ ] Create PermissionSet model
- [ ] Add permission level enum
- [ ] Add expiration support
- [ ] Add metadata support

##### 8.6: Testing
- [ ] Test get_permissions()
- [ ] Test set_permissions()
- [ ] Test bulk operations
- [ ] Test permission expiration
- [ ] Test access control
- [ ] Test error conditions

#### Deliverables
- get_permissions() implementation
- set_permissions() implementation
- Updated permission models
- Permission tests

#### Success Criteria
- ✅ get_permissions() returns correct data
- ✅ set_permissions() updates correctly
- ✅ Bulk operations work
- ✅ Old methods are removed
- ✅ Access control still works

---

### Phase 9: Core SDK Integration

#### Objectives
- Integrate all new features into core SDK
- Remove deprecated methods
- Update error handling
- Add comprehensive docstrings
- Update type hints

#### Tasks

##### 9.1: Update core.py
- [ ] Integrate all new methods
- [ ] Remove all deprecated methods
- [ ] Update method signatures
- [ ] Update error handling
- [ ] Update type hints
- [ ] Add comprehensive docstrings

##### 9.2: Update __init__.py
- [ ] Update exports
- [ ] Update version to 2.0.0
- [ ] Add deprecation warnings if needed

##### 9.3: Update Exceptions
- [ ] Add new exception types if needed
- [ ] Update error messages
- [ ] Add detailed error context

##### 9.4: Integration Testing
- [ ] Test full upload workflow
- [ ] Test full retrieval workflow
- [ ] Test permission workflows
- [ ] Test organization/agent management
- [ ] Test error scenarios
- [ ] Test edge cases

##### 9.5: Performance Testing
- [ ] Benchmark upload performance
- [ ] Benchmark listing performance
- [ ] Benchmark recursive search
- [ ] Benchmark permission checks
- [ ] Identify bottlenecks
- [ ] Optimize critical paths

#### Deliverables
- Updated core.py
- Integration test suite
- Performance benchmarks
- Optimization recommendations

#### Success Criteria
- ✅ All features work together
- ✅ No deprecated methods remain
- ✅ Error handling is comprehensive
- ✅ Performance is acceptable
- ✅ Type hints are complete

---

### Phase 10: Testing & Quality Assurance

#### Objectives
- Achieve >80% code coverage
- Test all breaking changes
- Test migration scenarios
- Performance validation
- Security testing

#### Tasks

##### 10.1: Unit Tests
- [ ] Update all repository tests
- [ ] Update all service tests
- [ ] Update all SDK tests
- [ ] Add tests for new features
- [ ] Add tests for edge cases

##### 10.2: Integration Tests
- [ ] Test complete workflows
- [ ] Test cross-feature interactions
- [ ] Test error propagation
- [ ] Test transaction handling

##### 10.3: Migration Tests
- [ ] Test v1 to v2 migration
- [ ] Test data integrity after migration
- [ ] Test rollback scenarios

##### 10.4: Performance Tests
- [ ] Benchmark all major operations
- [ ] Test with large datasets
- [ ] Test recursive search performance
- [ ] Test concurrent operations
- [ ] Identify performance regressions

##### 10.5: Security Tests
- [ ] Test permission enforcement
- [ ] Test organization isolation
- [ ] Test input validation
- [ ] Test SQL injection prevention
- [ ] Test access control bypasses

##### 10.6: Compatibility Tests
- [ ] Test on Python 3.10, 3.11, 3.12, 3.13
- [ ] Test on different platforms
- [ ] Test with different PostgreSQL versions
- [ ] Test with MinIO and S3

#### Deliverables
- Comprehensive test suite
- Coverage report (>80%)
- Performance benchmarks
- Security audit report
- Compatibility matrix

#### Success Criteria
- ✅ Code coverage >80%
- ✅ All tests pass
- ✅ No performance regressions
- ✅ No security vulnerabilities
- ✅ Works on all supported platforms

---

### Phase 11: Documentation & Examples

#### Objectives
- Update all documentation
- Create migration guide
- Update API reference
- Create new examples
- Update README

#### Tasks

##### 11.1: Update API Documentation
- [ ] Update `docs/API.md`
- [ ] Document all new methods
- [ ] Document breaking changes
- [ ] Add code examples
- [ ] Update parameter descriptions

##### 11.2: Create Migration Guide
- [ ] Create `docs/MIGRATION_V1_TO_V2.md`
- [ ] Document all breaking changes
- [ ] Provide migration examples
- [ ] Create migration checklist
- [ ] Document data migration process

##### 11.3: Update README
- [ ] Update feature list
- [ ] Update quick start examples
- [ ] Update API examples
- [ ] Add v2 highlights
- [ ] Update configuration section

##### 11.4: Update Examples
- [ ] Update `examples/basic_usage.py`
- [ ] Update `examples/access_control.py`
- [ ] Update `examples/versioning.py`
- [ ] Create `examples/hierarchical_documents.py`
- [ ] Create `examples/flexible_upload.py`
- [ ] Update `examples/README.md`

##### 11.5: Update CHANGELOG
- [ ] Document all changes in `CHANGELOG.md`
- [ ] Categorize changes (Added, Changed, Removed, Breaking)
- [ ] Add migration notes
- [ ] Add upgrade instructions

##### 11.6: Create Docstrings
- [ ] Update all function docstrings
- [ ] Add parameter descriptions
- [ ] Add return value descriptions
- [ ] Add usage examples
- [ ] Add deprecation warnings

#### Deliverables
- Updated API.md
- MIGRATION_V1_TO_V2.md
- Updated README.md
- Updated examples
- Updated CHANGELOG.md
- Complete docstrings

#### Success Criteria
- ✅ All methods are documented
- ✅ Migration guide is complete
- ✅ Examples work correctly
- ✅ CHANGELOG is comprehensive
- ✅ Documentation is clear and accurate

---

### Phase 12: Release Preparation

#### Objectives
- Final testing
- Version bumping
- Release notes
- Package building
- PyPI publishing

#### Tasks

##### 12.1: Final Testing
- [ ] Run complete test suite
- [ ] Test example scripts
- [ ] Test migration process
- [ ] Manual testing of key features
- [ ] Smoke testing

##### 12.2: Version Bumping
- [ ] Update version in `__init__.py` to 2.0.0
- [ ] Update version in `pyproject.toml`
- [ ] Update version references in docs

##### 12.3: Release Notes
- [ ] Create comprehensive release notes
- [ ] Highlight breaking changes
- [ ] List new features
- [ ] Provide upgrade instructions
- [ ] Add contributor acknowledgments

##### 12.4: Package Building
- [ ] Build wheel package
- [ ] Build source distribution
- [ ] Test package installation
- [ ] Validate package contents

##### 12.5: Git Tagging
- [ ] Create git tag v2.0.0
- [ ] Push tags to remote
- [ ] Create GitHub release

##### 12.6: PyPI Publishing
- [ ] Publish to Test PyPI
- [ ] Test installation from Test PyPI
- [ ] Publish to PyPI
- [ ] Verify package on PyPI

##### 12.7: Communication
- [ ] Update documentation site
- [ ] Write blog post/announcement
- [ ] Update GitHub README badges
- [ ] Notify users of release

#### Deliverables
- Release notes
- Published package on PyPI
- Git tags
- GitHub release
- Release announcement

#### Success Criteria
- ✅ Package builds successfully
- ✅ Package installs correctly
- ✅ All tests pass
- ✅ Documentation is deployed
- ✅ Release is announced

---

## Testing Strategy

### Unit Testing
- Test all repository methods
- Test all service methods
- Test all SDK methods
- Test utility functions
- Target: >80% coverage

### Integration Testing
- Test complete workflows
- Test service interactions
- Test database operations
- Test storage operations

### Migration Testing
- Test v1 to v2 migration
- Test data preservation
- Test rollback procedures

### Performance Testing
- Benchmark key operations
- Test with large datasets
- Test concurrent operations
- Identify bottlenecks

### Security Testing
- Test permission enforcement
- Test SQL injection prevention
- Test input validation
- Test access control

---

## Migration Guide

### For Users

#### 1. Update Dependencies
```bash
pip install docvault-sdk==2.0.0
```

#### 2. Update Organization/Agent Registration
```python
# v1.x
await vault.register_organization(external_id="org-123", name="My Org")
await vault.register_agent(
    external_id="agent-456",
    organization_id="org-123",
    name="Agent Name",
    email="agent@example.com"
)

# v2.0
import uuid
org_id = uuid.uuid4()
agent_id = uuid.uuid4()

await vault.register_organization(id=org_id)
await vault.register_agent(id=agent_id, organization_id=org_id)
```

#### 3. Update Method Calls
```python
# v1.x
await vault.share(doc_id, "agent-id", "READ", "granter-id")
await vault.check_permission(doc_id, "agent-id", "READ")

# v2.0
await vault.set_permissions(
    doc_id,
    agent_id=agent_uuid,
    org_id=org_uuid,
    permissions=[Permission(type="READ", agent_id=target_agent_uuid)],
    granted_by=granter_uuid
)
perms = await vault.get_permissions(doc_id, agent_uuid, org_uuid)
```

#### 4. Update Document Listing
```python
# v1.x
docs = await vault.list_documents("org-id", "agent-id")

# v2.0
docs = await vault.list_docs(
    org_id=org_uuid,
    agent_id=agent_uuid,
    prefix="/reports/",
    recursive=True
)
```

### Database Migration

#### 1. Backup Database
```bash
pg_dump doc_vault > doc_vault_v1_backup.sql
```

#### 2. Run Migration Script
```bash
psql doc_vault < migrate_v1_to_v2.sql
```

#### 3. Validate Migration
```sql
-- Check for data integrity
SELECT COUNT(*) FROM organizations;
SELECT COUNT(*) FROM agents;
SELECT COUNT(*) FROM documents;
```

---

## Risk Assessment

### High Risk Items

#### 1. Data Migration
**Risk**: Data loss during v1 to v2 migration  
**Mitigation**:
- Comprehensive backup procedures
- Thorough migration testing
- Rollback procedures
- Data validation checks

#### 2. Breaking Changes
**Risk**: Existing applications break  
**Mitigation**:
- Clear migration guide
- Deprecation warnings
- Detailed documentation
- Example migrations

#### 3. Performance Regressions
**Risk**: New features slow down operations  
**Mitigation**:
- Performance benchmarking
- Query optimization
- Index optimization
- Caching strategies

### Medium Risk Items

#### 1. UUID Management
**Risk**: UUID collisions or management issues  
**Mitigation**:
- UUID v4 generation
- Uniqueness constraints
- Validation checks

#### 2. Recursive Search Performance
**Risk**: Deep hierarchies cause slow queries  
**Mitigation**:
- max_depth limits
- Query optimization
- Index strategy
- Caching

#### 3. Permission System Changes
**Risk**: Security vulnerabilities in new API  
**Mitigation**:
- Security testing
- Code review
- Access control validation
- Audit logging

### Low Risk Items

#### 1. Documentation Gaps
**Risk**: Users confused by changes  
**Mitigation**:
- Comprehensive documentation
- Migration examples
- FAQ section

---

## Timeline

### Week 1-2: Foundation
- Phase 1: Database Schema & Migration
- Phase 2: Repository Layer Updates

### Week 3: Data Models
- Phase 3: Schema Models & Validation

### Week 4: Entity Management
- Phase 4: Organization & Agent Management

### Week 5-6: Document Features
- Phase 5: Document Prefix & Hierarchical Support
- Phase 6: Enhanced Upload System

### Week 7: Document Operations
- Phase 7: Document Listing & Retrieval

### Week 8: Access Control
- Phase 8: Permissions Refactoring

### Week 9: Integration
- Phase 9: Core SDK Integration

### Week 10: Quality Assurance
- Phase 10: Testing & Quality Assurance

### Week 11: Documentation
- Phase 11: Documentation & Examples

### Week 12: Release
- Phase 12: Release Preparation

**Total: 12 weeks (3 months)**

---

## Success Metrics

### Technical Metrics
- ✅ 100% of planned features implemented
- ✅ >80% code coverage
- ✅ Zero critical bugs
- ✅ <5% performance regression
- ✅ All breaking changes documented

### Documentation Metrics
- ✅ 100% of public APIs documented
- ✅ Migration guide completed
- ✅ All examples working
- ✅ CHANGELOG comprehensive

### Release Metrics
- ✅ Package published to PyPI
- ✅ Documentation deployed
- ✅ Release announced
- ✅ User feedback collected

---

## Appendix

### A. Configuration Changes
No configuration changes required for v2.0

### B. Dependency Updates
No new dependencies required

### C. Performance Targets
- Upload: <100ms for small files (<1MB)
- Download: <50ms for small files
- List: <200ms for 100 documents
- Recursive search: <500ms for 1000 documents with depth 5
- Permission check: <10ms

### D. Backwards Compatibility
v2.0 is **NOT** backwards compatible with v1.x due to:
- Database schema changes
- API method changes
- ID system changes

### E. Support Policy
- v1.x: Security fixes only for 6 months after v2.0 release
- v2.0: Full support and feature development

---

**Document Version**: 1.0  
**Last Updated**: November 20, 2025  
**Author**: DocVault Team  
**Status**: Draft
