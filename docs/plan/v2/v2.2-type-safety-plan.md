# DocVault v2.2 Type Safety & API Polish Plan

**Version**: 2.2.0  
**Status**: Planning  
**Created**: November 21, 2025  
**Priority**: High (Type Safety, API Consistency, Developer Experience)

---

## Executive Summary

This plan addresses type safety gaps and API inconsistencies discovered in v2.1. The focus is on replacing generic `Dict[str, Any]` and `List[Any]` return types with proper Pydantic models, ensuring type-safe APIs, and improving string input handling for file uploads.

### Key Issues Identified

1. **Type Safety Gaps**: Methods return `Dict[str, Any]` instead of proper models
2. **Upload String Ambiguity**: `file_input: str` claims to support "text content" but only handles file paths
3. **Mixed Permission Types**: `set_permissions()` still accepts `List[dict]` alongside `List[PermissionGrant]`
4. **Obsolete Helper Method**: `_resolve_external_ids()` adds complexity without benefits in v2.x

### Goals

- **100% Type Safety**: All public methods return explicit Pydantic models
- **Clear String Handling**: Automatic detection of file path vs. text content in uploads
- **Consistent Permission API**: Only `List[PermissionGrant]` accepted
- **Simplified Codebase**: Remove v1.x compatibility helpers

---

## Table of Contents

1. [Issue Analysis](#issue-analysis)
2. [New Response Models](#new-response-models)
3. [Implementation Plan](#implementation-plan)
4. [Testing Strategy](#testing-strategy)
5. [Migration Guide](#migration-guide)
6. [Timeline](#timeline)

---

## Issue Analysis

### Issue 1: Generic Dict/Any Return Types âŒ

**Current State:**
```python
# core.py - Multiple methods returning Dict[str, Any]
async def list_docs(...) -> Dict[str, Any]:  # âŒ
async def search(...) -> Dict[str, Any]:  # âŒ
async def get_document_details(...) -> Dict[str, Any]:  # âŒ
async def get_permissions(...) -> Dict[str, Any]:  # âŒ
async def set_permissions(...) -> List[Any]:  # âŒ
```

**Problems:**
1. No IDE autocomplete for response fields
2. Runtime errors instead of type checker errors
3. Unclear API contracts - what fields exist?
4. Can't use static type checkers effectively
5. Poor developer experience

**Expected Behavior:**
```python
# All methods return explicit models
async def list_docs(...) -> DocumentListResponse:
async def search(...) -> SearchResponse:
async def get_document_details(...) -> DocumentDetails:
async def get_permissions(...) -> PermissionListResponse:
async def set_permissions(...) -> List[DocumentACL]:
```

---

### Issue 2: Upload String Input Ambiguity âš ï¸

**Current State:**
```python
# core.py docstring says:
"""
file_input: Union[str, bytes, BinaryIO]
    - File path (str): Path to file on disk
    - Text content (str): Raw text to upload  # âŒ NOT IMPLEMENTED
    - Bytes (bytes): Binary content
    - Stream (BinaryIO): File-like object
"""

# But document_service.py only handles file paths:
async def upload_enhanced(
    self,
    file_input: Union[str, bytes, BinaryIO],  # str = file path only!
    ...
):
    file_content, filename, size = self._extract_file_info(file_input)
    # _extract_file_info treats str as file path, not text content!
```

**Problem:**
- Documentation promises text content support
- Implementation doesn't deliver
- Confusing for users
- No way to upload text without creating temp file

**Solution:**
Implement smart string detection in `_extract_file_info()`:
```python
def _extract_file_info(self, file_input: Union[str, bytes, BinaryIO]) -> tuple[bytes, str, int]:
    if isinstance(file_input, str):
        # Check if it's a file path or text content
        if Path(file_input).exists():
            # It's a file path - read it
            with open(file_input, 'rb') as f:
                content = f.read()
            filename = Path(file_input).name
        else:
            # Treat as text content
            content = file_input.encode('utf-8')
            filename = "document.txt"
        return content, filename, len(content)
    # ... rest of handling for bytes/BinaryIO
```

---

### Issue 3: Mixed Permission Types ðŸ”§

**Current State:**
```python
# v2.1 - Still accepts both types
async def set_permissions(
    self,
    document_id: str | UUID,
    permissions: List[PermissionGrant] | List[dict],  # âŒ Still allows dict
    granted_by: str | UUID,
) -> List[Any]:  # âŒ Generic return type
```

**Problem:**
- Hybrid approach adds validation complexity
- Users might keep using dicts
- Not fully type-safe
- Return type is generic

**Solution:**
```python
# v2.2 - Type-safe only
async def set_permissions(
    self,
    document_id: str | UUID,
    permissions: List[PermissionGrant],  # âœ… Model only
    granted_by: str | UUID,
) -> List[DocumentACL]:  # âœ… Explicit return type
```

---

### Issue 4: Obsolete _resolve_external_ids() Helper ðŸ—‘ï¸

**Current State:**
```python
# core.py - Used in 4 methods
async def _resolve_external_ids(
    self, 
    organization_id: Optional[str] = None, 
    agent_id: Optional[str] = None
) -> tuple[Optional[UUID], Optional[UUID]]:
    """Convert external_id strings to internal UUIDs."""
    # This is v1.x legacy - v2.x uses UUIDs directly as primary keys!
    ...

# Used in:
async def download(self, document_id, agent_id: str, ...):  # agent_id: str only
    _, agent_uuid = await self._resolve_external_ids(agent_id=agent_id)
    
async def update_metadata(self, document_id, agent_id: str, ...):
    _, agent_uuid = await self._resolve_external_ids(agent_id=agent_id)
    
async def delete(self, document_id, agent_id: str, ...):
    _, agent_uuid = await self._resolve_external_ids(agent_id=agent_id)
    
async def restore_version(self, document_id, version_number, agent_id: str, ...):
    _, agent_uuid = await self._resolve_external_ids(agent_id=agent_id)
```

**Problems:**
1. **No longer needed in v2.x**: Organizations/Agents use UUIDs directly as primary keys
2. **Adds database calls**: Queries organization/agent tables unnecessarily
3. **Inconsistent API**: Some methods accept `str | UUID`, these accept `str` only
4. **Performance overhead**: Extra DB roundtrips
5. **V1.x baggage**: Carries forward v1.x `external_id` concept that v2.0 removed

**Solution:**
Remove `_resolve_external_ids()` and update affected methods:
```python
# v2.2 - Consistent with other methods
async def download(
    self, 
    document_id: UUID, 
    agent_id: str | UUID,  # âœ… Accept both types
    ...
):
    # Service layer handles UUID conversion with _ensure_uuid()
    return await self._document_service.download_document(
        document_id=document_id,
        agent_id=agent_id,  # Service converts to UUID
        ...
    )
```

**Why This Works:**
- Service layer already has `_ensure_uuid()` helper
- No database lookups needed
- Consistent with 90% of SDK methods
- Simpler, cleaner code

---

## New Response Models

We need to create comprehensive response models for all SDK methods that currently return generic types.

### Model Categories

#### 1. Document List & Search Responses

**File**: `src/doc_vault/database/schemas/responses.py` (NEW)

```python
from typing import List, Optional, Any, Dict
from uuid import UUID
from pydantic import BaseModel, Field
from .document import Document
from .version import DocumentVersion
from .acl import DocumentACL

class PaginationMeta(BaseModel):
    """Pagination metadata."""
    total: int = Field(..., description="Total number of items")
    limit: int = Field(..., description="Items per page")
    offset: int = Field(..., description="Starting offset")
    has_more: bool = Field(..., description="Whether more items exist")

class DocumentListResponse(BaseModel):
    """Response model for list_docs() method."""
    documents: List[Document] = Field(default_factory=list, description="List of documents")
    pagination: PaginationMeta = Field(..., description="Pagination information")
    filters: Dict[str, Any] = Field(default_factory=dict, description="Applied filters")

class SearchResponse(BaseModel):
    """Response model for search() method."""
    documents: List[Document] = Field(default_factory=list, description="Matching documents")
    query: str = Field(..., description="Search query")
    pagination: PaginationMeta = Field(..., description="Pagination information")
    filters: Dict[str, Any] = Field(default_factory=dict, description="Applied filters")
```

#### 2. Document Details Response

```python
class DocumentDetails(BaseModel):
    """Comprehensive document details with optional versions and permissions."""
    document: Document = Field(..., description="Document metadata")
    versions: Optional[List[DocumentVersion]] = Field(None, description="Version history (if requested)")
    permissions: Optional[List[DocumentACL]] = Field(None, description="Access permissions (if ADMIN and requested)")
    version_count: int = Field(..., description="Total number of versions")
    current_version: int = Field(..., description="Current version number")
```

#### 3. Permission Response

```python
class PermissionListResponse(BaseModel):
    """Response model for get_permissions() method."""
    document_id: UUID = Field(..., description="Document UUID")
    permissions: List[DocumentACL] = Field(default_factory=list, description="List of permissions")
    total: int = Field(..., description="Total permission count")
    
    # Metadata about the request
    requested_by: Optional[UUID] = Field(None, description="Agent who requested permissions")
    requested_at: datetime = Field(default_factory=datetime.utcnow, description="When permissions were retrieved")
```

#### 4. Transfer Ownership Response

```python
class OwnershipTransferResponse(BaseModel):
    """Response model for transfer_ownership() method."""
    document: Document = Field(..., description="Updated document")
    old_owner: UUID = Field(..., description="Previous owner agent ID")
    new_owner: UUID = Field(..., description="New owner agent ID")
    transferred_by: UUID = Field(..., description="Agent who performed transfer")
    transferred_at: datetime = Field(default_factory=datetime.utcnow, description="Transfer timestamp")
    new_permissions: List[DocumentACL] = Field(..., description="Updated permission list")
```

### Export All New Models

Add to `src/doc_vault/database/schemas/__init__.py`:
```python
from .responses import (
    PaginationMeta,
    DocumentListResponse,
    SearchResponse,
    DocumentDetails,
    PermissionListResponse,
    OwnershipTransferResponse,
)

__all__ = [
    # ... existing exports ...
    # Response models (v2.2)
    "PaginationMeta",
    "DocumentListResponse",
    "SearchResponse",
    "DocumentDetails",
    "PermissionListResponse",
    "OwnershipTransferResponse",
]
```

---

## Implementation Plan

### Phase 1: Response Models Creation (2 days)

#### Task 1.1: Create Response Models File
- [ ] Create `src/doc_vault/database/schemas/responses.py`
- [ ] Define all response models with comprehensive docstrings
- [ ] Add validation and field descriptions
- [ ] Export from `__init__.py`

#### Task 1.2: Update Core SDK Imports
- [ ] Import new response models in `core.py`
- [ ] Update type hints for all affected methods
- [ ] Update docstrings with new return types

**Files Modified:**
- `src/doc_vault/database/schemas/responses.py` (NEW - ~200 lines)
- `src/doc_vault/database/schemas/__init__.py` (add exports)
- `src/doc_vault/core.py` (add imports)

---

### Phase 2: Service Layer Updates (3 days)

#### Task 2.1: Update Document Service Return Types
- [ ] `list_documents_paginated()` â†’ return `DocumentListResponse`
- [ ] `search_documents()` â†’ return `SearchResponse`
- [ ] `get_document_details()` â†’ return `DocumentDetails`

**File**: `src/doc_vault/services/document_service.py`

```python
# Before
async def list_documents_paginated(...) -> Dict[str, Any]:
    return {
        "documents": docs,
        "pagination": {...},
        "filters": {...}
    }

# After
async def list_documents_paginated(...) -> DocumentListResponse:
    return DocumentListResponse(
        documents=docs,
        pagination=PaginationMeta(
            total=total,
            limit=limit,
            offset=offset,
            has_more=(offset + limit) < total
        ),
        filters={...}
    )
```

#### Task 2.2: Update Access Service Return Types
- [ ] `get_permissions_detailed()` â†’ return `PermissionListResponse`
- [ ] `set_permissions()` â†’ return `List[DocumentACL]` (already done)

**File**: `src/doc_vault/services/access_service.py`

#### Task 2.3: Implement Smart String Detection in Upload
- [ ] Update `_extract_file_info()` to detect file path vs. text content
- [ ] Add logic: if `Path(file_input).exists()` â†’ file path, else â†’ text content
- [ ] Test with both file paths and text strings
- [ ] Update docstrings

**File**: `src/doc_vault/services/document_service.py`

```python
def _extract_file_info(
    self, file_input: Union[str, bytes, BinaryIO]
) -> tuple[bytes, str, int]:
    """
    Extract file content, filename, and size from various input types.
    
    For str input:
    - If path exists on disk â†’ read file
    - If path doesn't exist â†’ treat as text content
    
    Args:
        file_input: File path, text content, bytes, or binary stream
        
    Returns:
        Tuple of (content_bytes, filename, size)
    """
    if isinstance(file_input, str):
        path = Path(file_input)
        if path.exists() and path.is_file():
            # It's a file path - read it
            with open(path, 'rb') as f:
                content = f.read()
            filename = path.name
        else:
            # Treat as text content
            content = file_input.encode('utf-8')
            filename = "document.txt"  # Default for text content
        return content, filename, len(content)
    
    elif isinstance(file_input, bytes):
        # Raw bytes
        return file_input, "document.bin", len(file_input)
    
    elif hasattr(file_input, 'read'):
        # Binary stream (BinaryIO)
        content = file_input.read()
        if hasattr(file_input, 'seek'):
            file_input.seek(0)  # Reset stream for potential re-reading
        
        # Try to get filename from stream
        filename = getattr(file_input, 'name', 'document.bin')
        if hasattr(filename, '__fspath__'):
            filename = Path(filename).name
        
        return content, filename, len(content)
    
    else:
        raise ValidationError(
            f"Invalid file_input type: {type(file_input)}. "
            "Expected str (file path or text), bytes, or BinaryIO."
        )
```

**Files Modified:**
- `src/doc_vault/services/document_service.py` (~50 lines modified)
- `src/doc_vault/services/access_service.py` (~30 lines modified)

---

### Phase 3: Core SDK Signature Updates (2 days)

#### Task 3.1: Update Return Type Hints
- [ ] `list_docs()` â†’ `DocumentListResponse`
- [ ] `search()` â†’ `SearchResponse`
- [ ] `get_document_details()` â†’ `DocumentDetails`
- [ ] `get_permissions()` â†’ `PermissionListResponse`
- [ ] `set_permissions()` â†’ `List[DocumentACL]` (already correct)
- [ ] `transfer_ownership()` â†’ `OwnershipTransferResponse`

#### Task 3.2: Remove Dict Support from set_permissions()
- [ ] Change signature: `permissions: List[PermissionGrant]` (remove `| List[dict]`)
- [ ] Remove dict-to-model conversion logic
- [ ] Update docstrings to reflect model-only input
- [ ] Update error messages

**File**: `src/doc_vault/core.py`

```python
# Before (v2.1)
async def set_permissions(
    self,
    document_id: str | UUID,
    permissions: List[PermissionGrant] | List[dict],  # âŒ Mixed
    granted_by: str | UUID,
) -> List[Any]:  # âŒ Generic
    # Convert dicts to PermissionGrant if needed
    if permissions and isinstance(permissions[0], dict):
        permissions = [PermissionGrant(**p) for p in permissions]
    ...

# After (v2.2)
async def set_permissions(
    self,
    document_id: str | UUID,
    permissions: List[PermissionGrant],  # âœ… Model only
    granted_by: str | UUID,
) -> List[DocumentACL]:  # âœ… Explicit return type
    # No conversion needed - type-safe from the start
    ...
```

#### Task 3.3: Remove _resolve_external_ids() Method
- [ ] Delete `_resolve_external_ids()` method
- [ ] Update `download()`: `agent_id: str` â†’ `agent_id: str | UUID`
- [ ] Update `update_metadata()`: `agent_id: str` â†’ `agent_id: str | UUID`
- [ ] Update `delete()`: `agent_id: str` â†’ `agent_id: str | UUID`
- [ ] Update `restore_version()`: `agent_id: str` â†’ `agent_id: str | UUID`
- [ ] Remove calls to `_resolve_external_ids()` in these methods
- [ ] Service layer handles UUID conversion

**File**: `src/doc_vault/core.py`

```python
# Before (v2.1)
async def download(
    self,
    document_id: UUID,
    agent_id: str,  # âŒ Only str
    version: Optional[int] = None,
) -> bytes:
    # Resolve external_id to UUID (v1.x legacy)
    _, agent_uuid = await self._resolve_external_ids(agent_id=agent_id)
    
    return await self._document_service.download_document(
        document_id=document_id,
        agent_id=agent_uuid,  # Pass UUID
        version=version,
    )

# After (v2.2)
async def download(
    self,
    document_id: UUID,
    agent_id: str | UUID,  # âœ… Accept both
    version: Optional[int] = None,
) -> bytes:
    # Service handles UUID conversion with _ensure_uuid()
    return await self._document_service.download_document(
        document_id=document_id,
        agent_id=agent_id,  # Service converts if needed
        version=version,
    )
```

**Files Modified:**
- `src/doc_vault/core.py` (~150 lines modified)

---

### Phase 4: Documentation Updates (1 day)

#### Task 4.1: Update API Documentation
- [ ] Update `docs/API.md` with new response models
- [ ] Document all model fields
- [ ] Add examples for each response type
- [ ] Update method signatures

#### Task 4.2: Create Migration Guide
- [ ] Create `docs/MIGRATION_v2.1_to_v2.2.md`
- [ ] Document breaking changes
- [ ] Provide before/after examples
- [ ] List migration steps

#### Task 4.3: Update Examples
- [ ] Update `examples/basic_usage.py` with type-safe code
- [ ] Update `examples/access_control.py` with PermissionGrant
- [ ] Show text content upload in examples
- [ ] Add type hints to example code

**Files Modified:**
- `docs/API.md` (~200 lines modified)
- `docs/MIGRATION_v2.1_to_v2.2.md` (NEW - ~300 lines)
- `examples/basic_usage.py` (~50 lines modified)
- `examples/access_control.py` (~30 lines modified)

---

### Phase 5: Testing (3 days)

#### Task 5.1: Unit Tests for Response Models
- [ ] Test all response model validation
- [ ] Test field serialization/deserialization
- [ ] Test model composition (nested models)

**File**: `tests/test_response_models.py` (NEW - ~200 lines)

#### Task 5.2: Integration Tests for SDK Methods
- [ ] Test `list_docs()` returns `DocumentListResponse`
- [ ] Test `search()` returns `SearchResponse`
- [ ] Test `get_document_details()` returns `DocumentDetails`
- [ ] Test `get_permissions()` returns `PermissionListResponse`
- [ ] Test `transfer_ownership()` returns `OwnershipTransferResponse`

**File**: `tests/test_core_v2_2.py` (NEW - ~300 lines)

#### Task 5.3: Upload String Detection Tests
- [ ] Test upload with file path (existing behavior)
- [ ] Test upload with text content (new behavior)
- [ ] Test upload with bytes (existing)
- [ ] Test upload with BinaryIO (existing)
- [ ] Test error handling for invalid inputs

**File**: `tests/test_upload_string_detection.py` (NEW - ~150 lines)

#### Task 5.4: Permission Model-Only Tests
- [ ] Test `set_permissions()` with `PermissionGrant` models
- [ ] Test that dict input is rejected with clear error
- [ ] Test return type is `List[DocumentACL]`

**File**: `tests/test_core_permissions.py` (modify existing)

#### Task 5.5: Remove _resolve_external_ids Tests
- [ ] Update tests for `download()`, `update_metadata()`, `delete()`, `restore_version()`
- [ ] Test with both `str` and `UUID` for agent_id
- [ ] Ensure no database lookups for UUID conversion

**Files Modified:**
- `tests/test_response_models.py` (NEW)
- `tests/test_core_v2_2.py` (NEW)
- `tests/test_upload_string_detection.py` (NEW)
- `tests/test_core_permissions.py` (modify)
- `tests/test_core.py` (modify)

---

### Phase 6: Release Preparation (1 day)

#### Task 6.1: Update CHANGELOG
- [ ] Document all v2.2 changes
- [ ] List breaking changes
- [ ] Provide migration guidance
- [ ] Update version number

**File**: `CHANGELOG.md`

#### Task 6.2: Update README
- [ ] Update quick start with type-safe examples
- [ ] Show response model usage
- [ ] Update feature list
- [ ] Bump version to v2.2.0

**File**: `README.md`

#### Task 6.3: Version Bump
- [ ] Update `pyproject.toml` version to `2.2.0`
- [ ] Update `__version__` in `__init__.py`

**Files Modified:**
- `CHANGELOG.md` (~100 lines added)
- `README.md` (~50 lines modified)
- `pyproject.toml` (version bump)
- `src/doc_vault/__init__.py` (version bump)

---

## Testing Strategy

### Unit Tests
- **Response Models**: Validate all fields, types, defaults
- **String Detection**: Test file path vs. text content logic
- **Permission Models**: Ensure dict input is rejected

### Integration Tests
- **End-to-End SDK Calls**: Test full workflow with response models
- **Type Checking**: Run mypy/pyright to validate type safety
- **Upload Scenarios**: Test all upload input types

### Regression Tests
- **Existing Tests**: All existing tests must pass
- **Examples**: All example scripts must run successfully
- **Performance**: No performance regression from model overhead

### Test Coverage Goals
- **Minimum**: 85% overall coverage
- **New Code**: 95% coverage for new response models
- **Critical Paths**: 100% coverage for upload and permission changes

---

## Migration Guide (v2.1 â†’ v2.2)

### Breaking Changes Summary

1. **Response Types Changed**: Methods return models instead of dicts
2. **set_permissions() Signature**: Only accepts `List[PermissionGrant]`, no dicts
3. **_resolve_external_ids() Removed**: Internal method removed (shouldn't affect most users)
4. **agent_id Type Expanded**: Four methods now accept `str | UUID` instead of `str` only

### Migration Steps

#### 1. Update Response Handling

**Before (v2.1):**
```python
# Returns Dict[str, Any]
result = await vault.list_docs(org_id=org, agent_id=agent)
docs = result["documents"]  # Access dict keys
total = result["pagination"]["total"]
```

**After (v2.2):**
```python
# Returns DocumentListResponse model
result = await vault.list_docs(org_id=org, agent_id=agent)
docs = result.documents  # Access model attributes
total = result.pagination.total  # Type-safe access
```

#### 2. Update Permission Calls

**Before (v2.1):**
```python
# Could use dicts
await vault.set_permissions(
    document_id=doc_id,
    permissions=[
        {"agent_id": agent1, "permission": "READ"},  # Dict
        {"agent_id": agent2, "permission": "WRITE"},  # Dict
    ],
    granted_by=admin,
)
```

**After (v2.2):**
```python
from doc_vault.database.schemas import PermissionGrant

# Must use PermissionGrant models
await vault.set_permissions(
    document_id=doc_id,
    permissions=[
        PermissionGrant(agent_id=agent1, permission="READ"),
        PermissionGrant(agent_id=agent2, permission="WRITE"),
    ],
    granted_by=admin,
)
```

#### 3. Text Content Upload (New Feature)

**Before (v2.1):**
```python
# Had to create temp file for text content
import tempfile
with tempfile.NamedTemporaryFile(mode='w', delete=False) as f:
    f.write("My document content")
    temp_path = f.name

doc = await vault.upload(
    file_input=temp_path,  # File path
    ...
)
os.unlink(temp_path)  # Clean up
```

**After (v2.2):**
```python
# Direct text upload
doc = await vault.upload(
    file_input="My document content",  # Text content
    name="my_doc.txt",
    ...
)
# Automatically detected as text content, not file path!
```

#### 4. Type Hints in Your Code

**Before (v2.1):**
```python
async def my_function(vault: DocVaultSDK) -> Dict[str, Any]:  # Generic
    result = await vault.list_docs(...)
    return result  # No type safety
```

**After (v2.2):**
```python
from doc_vault.database.schemas import DocumentListResponse

async def my_function(vault: DocVaultSDK) -> DocumentListResponse:  # Explicit
    result = await vault.list_docs(...)
    return result  # Type-safe
```

### Non-Breaking Changes

- `agent_id` parameters now accept `str | UUID` (previously `str` only) - backward compatible
- Response models can be serialized to dicts with `.model_dump()` if needed
- All existing functionality preserved

---

## Timeline

**Total Duration**: 12 days (2.4 weeks)

| Phase | Duration | Tasks | Dependencies |
|-------|----------|-------|--------------|
| **Phase 1** | 2 days | Create response models | None |
| **Phase 2** | 3 days | Update service layer | Phase 1 |
| **Phase 3** | 2 days | Update core SDK | Phase 1, 2 |
| **Phase 4** | 1 day | Documentation | Phase 3 |
| **Phase 5** | 3 days | Testing | Phase 3 |
| **Phase 6** | 1 day | Release prep | Phase 4, 5 |

**Target Release**: December 5, 2025

---

## Success Criteria

### Code Quality
- [ ] No `Dict[str, Any]` or `List[Any]` return types in public API
- [ ] All response models have comprehensive docstrings
- [ ] 100% type hint coverage in `core.py`
- [ ] Mypy/pyright pass with no errors

### Testing
- [ ] All existing tests pass
- [ ] New tests for response models (>95% coverage)
- [ ] Upload string detection tests (100% coverage)
- [ ] Permission model-only tests pass

### Documentation
- [ ] API.md updated with response models
- [ ] Migration guide complete with examples
- [ ] CHANGELOG.md comprehensive
- [ ] Examples updated and tested

### Release
- [ ] Version bumped to 2.2.0
- [ ] Git tag created
- [ ] PyPI package published
- [ ] Release announcement prepared

---

## Risk Assessment

### Low Risk
- âœ… Response model creation (additive, no breaking changes)
- âœ… String detection in upload (backward compatible)
- âœ… Type hint additions (compile-time only)

### Medium Risk
- âš ï¸ Removing dict support from `set_permissions()` (breaking change)
  - **Mitigation**: Clear error messages, migration guide
- âš ï¸ Service layer return type changes (internal API)
  - **Mitigation**: Comprehensive testing

### High Risk
- ðŸ”´ None identified

### Mitigation Strategies
1. **Comprehensive Testing**: 3 days dedicated to testing
2. **Clear Migration Guide**: Step-by-step upgrade instructions
3. **Backward Compatibility**: Response models support `.model_dump()` for dict access
4. **Early Documentation**: Write migration guide during implementation

---

## Post-Release

### Monitoring
- Track PyPI download metrics
- Monitor GitHub issues for migration problems
- Collect user feedback on new response models

### Future Improvements (v2.3+)
- Add more response model convenience methods (e.g., `.to_dataframe()`)
- Consider deprecation warnings for dict-style access
- Explore GraphQL-style field selection for large responses
- Add response model JSON schema export

---

## Appendix: Complete Method Signature Changes

### Before (v2.1)

```python
# Generic return types
async def list_docs(...) -> Dict[str, Any]: ...
async def search(...) -> Dict[str, Any]: ...
async def get_document_details(...) -> Dict[str, Any]: ...
async def get_permissions(...) -> Dict[str, Any]: ...
async def set_permissions(..., permissions: List[PermissionGrant] | List[dict], ...) -> List[Any]: ...
async def transfer_ownership(...) -> ...: ...  # No return type hint

# Limited agent_id types
async def download(..., agent_id: str, ...) -> bytes: ...
async def update_metadata(..., agent_id: str, ...) -> ...: ...
async def delete(..., agent_id: str, ...) -> None: ...
async def restore_version(..., agent_id: str, ...) -> ...: ...
```

### After (v2.2)

```python
# Explicit model return types
async def list_docs(...) -> DocumentListResponse: ...
async def search(...) -> SearchResponse: ...
async def get_document_details(...) -> DocumentDetails: ...
async def get_permissions(...) -> PermissionListResponse: ...
async def set_permissions(..., permissions: List[PermissionGrant], ...) -> List[DocumentACL]: ...
async def transfer_ownership(...) -> OwnershipTransferResponse: ...

# Expanded agent_id types (consistent with other methods)
async def download(..., agent_id: str | UUID, ...) -> bytes: ...
async def update_metadata(..., agent_id: str | UUID, ...) -> Document: ...
async def delete(..., agent_id: str | UUID, ...) -> None: ...
async def restore_version(..., agent_id: str | UUID, ...) -> DocumentVersion: ...
```

---

## Questions & Feedback

For questions about v2.2 implementation:
- Create an issue with label `v2.2-type-safety`
- Discussion: GitHub Discussions - v2.2 Planning
- Contact: team@docvault.dev

---

**Status**: Ready for implementation âœ…  
**Next Step**: Create response models (Phase 1, Task 1.1)
